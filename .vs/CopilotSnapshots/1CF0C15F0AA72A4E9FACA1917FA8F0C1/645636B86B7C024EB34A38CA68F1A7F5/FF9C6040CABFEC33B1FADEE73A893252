using System;
using System.Runtime.InteropServices;
using System.Diagnostics;
using System.Windows.Forms;

// P/Invoke ve Memory Yönetimi için Statik Sınıf
public static class MemoryHelper
{
    // kernel32.dll dari P/Invoke Deklarasyonları
    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern IntPtr OpenProcess(uint dwDesiredAccess, bool bInheritHandle, int dwProcessId);

    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, uint nSize, out IntPtr lpNumberOfBytesWritten);

    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern bool ReadProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, uint nSize, out IntPtr lpNumberOfBytesRead);

    [DllImport("kernel32.dll", SetLastError = true)]
    public static extern bool CloseHandle(IntPtr hObject);

    // Sabitler
    public const uint PROCESS_ALL_ACCESS = 0x1F0FFF;
    public const uint PROCESS_VM_WRITE = 0x0020;
    public const uint PROCESS_VM_READ = 0x0010;

    // Bellek yazma fonksiyonu (Integer değer için)
    public static bool WriteMemory(IntPtr hProcess, IntPtr address, int value)
    {
        byte[] buffer = BitConverter.GetBytes(value);
        IntPtr bytesWritten;
        return WriteProcessMemory(hProcess, address, buffer, (uint)buffer.Length, out bytesWritten);
    }

    // Bellek yazma fonksiyonu (Float değer için)
    public static bool WriteMemory(IntPtr hProcess, IntPtr address, float value)
    {
        byte[] buffer = BitConverter.GetBytes(value);
        IntPtr bytesWritten;
        return WriteProcessMemory(hProcess, address, buffer, (uint)buffer.Length, out bytesWritten);
    }

    // Bellek okuma fonksiyonu (Integer değer için)
    public static int ReadMemory(IntPtr hProcess, IntPtr address)
    {
        byte[] buffer = new byte[4];
        IntPtr bytesRead;
        ReadProcessMemory(hProcess, address, buffer, 4, out bytesRead);
        return BitConverter.ToInt32(buffer, 0);
    }
}

namespace cheat
{
    public partial class Form1 : Form
    {
        private IntPtr processHandle = IntPtr.Zero;
        private int targetProcessId = -1;
        private const string TargetProcessName = "gta-sa"; // always target gta-sa.exe
        // Note: address remains hard-coded in code but is not shown in the UI
        private readonly IntPtr targetAddress = new IntPtr(0xB7CE50);

        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
            // Form yüklendiğinde bilgilendirme mesajı
            MessageBox.Show(
                "Kadir - GTA:SA Para Editörü\n\n" +
                "- Hedef işlem otomatik: gta-sa.exe\n" +
                "- Para miktarını girin ve 'Belleğe Yaz' tıklayın\n\n" +
                "NOT: Uygulamayı yönetici olarak çalıştırmanız gerekebilir.",
                "Hoş Geldiniz"
            );
            UpdateStatus(false);
        }

        // Durum güncellemesi
        private void UpdateStatus(bool connected)
        {
            if (connected)
            {
                statusLabel.Text = $"Durum: Bağlı ✓ (PID: {targetProcessId})";
                statusLabel.ForeColor = System.Drawing.Color.Green;
            }
            else
            {
                statusLabel.Text = "Durum: Bağlı Değil ✗";
                statusLabel.ForeColor = System.Drawing.Color.Red;
            }
        }

        // ===== Butonlar ve Event Handlerlar =====

        // Belleği okuyup messagebox'a yazma
        private void ReadMemoryBtn_Click(object sender, EventArgs e)
        {
            if (processHandle == IntPtr.Zero)
            {
                MessageBox.Show("Lütfen önce GTA:SA işlemine bağlanın!", "Hata");
                return;
            }

            int value = MemoryHelper.ReadMemory(processHandle, targetAddress);
            MessageBox.Show($"Okunan Para Miktarı: {value}\n(Hex: 0x{value:X})", "Sonuç");
        }

        // Textbox'taki değeri belleğe yazma
        private void WriteMemoryBtn_Click(object sender, EventArgs e)
        {
            if (processHandle == IntPtr.Zero)
            {
                MessageBox.Show("Lütfen önce GTA:SA işlemine bağlanın!", "Hata");
                return;
            }

            // Yazılacak değeri al
            if (!int.TryParse(ValueTextBox.Text, out int newValue))
            {
                MessageBox.Show("Lütfen geçerli bir sayı giriniz!", "Hata");
                return;
            }

            bool success = MemoryHelper.WriteMemory(processHandle, targetAddress, newValue);

            if (success)
            {
                MessageBox.Show($"Yazma Başarılı!\nYeni Para Miktarı: {newValue} (0x{newValue:X})", "Başarılı");
            }
            else
            {
                MessageBox.Show("Yazma Başarısız! Hata: " + Marshal.GetLastWin32Error(), "Hata");
            }
        }

        // İşleme bağlanma (sabit: gta-sa.exe)
        private void ConnectBtn_Click(object sender, EventArgs e)
        {
            string processName = TargetProcessName; // always use gta-sa

            // Belirtilen işlemi bul
            Process[] processes = Process.GetProcessesByName(processName);

            if (processes.Length == 0)
            {
                MessageBox.Show($"İşlem bulunamadı: {processName}.exe\nLütfen GTA:SA'nin çalıştığından emin olun.", "Hata");
                UpdateStatus(false);
                return;
            }

            // İlk eşleşen işleme bağlan
            targetProcessId = processes[0].Id;
            processHandle = MemoryHelper.OpenProcess(MemoryHelper.PROCESS_ALL_ACCESS, false, targetProcessId);

            if (processHandle == IntPtr.Zero)
            {
                MessageBox.Show("İşleme bağlanılamadı! Yönetici haklarına ihtiyacınız olabilir.\nHata Kodu: " + Marshal.GetLastWin32Error(), "Hata");
                UpdateStatus(false);
                return;
            }

            MessageBox.Show($"Bağlanıldı!\nİşlem: {processes[0].ProcessName} (PID: {targetProcessId})", "Başarılı");
            UpdateStatus(true);
        }

        // Kaynakları temizleme
        private void Form1_FormClosing(object sender, FormClosingEventArgs e)
        {
            if (processHandle != IntPtr.Zero)
            {
                MemoryHelper.CloseHandle(processHandle);
            }
        }
    }
}